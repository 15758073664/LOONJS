/**
 * OPPO å•†åŸ ç­¾åˆ°
 */

const TOKEN_KEY = "oppo_constToken";
const ACTIVITY_KEY = "oppo_activityId";
const TIMEOUT = 5000;

const token = $persistentStore.read(TOKEN_KEY);
const activityId = $persistentStore.read(ACTIVITY_KEY);

function notify(msg) {
  $notification.post("OPPO å•†åŸç­¾åˆ°", "", msg);
}

if (!token) {
  notify("âŒ æœªè·å– constToken");
  return $done();
}

if (!activityId) {
  notify("âŒ æœªè·å– activityIdï¼Œè¯·å…ˆæ‰‹åŠ¨æ‰“å¼€ç­¾åˆ°é¡µ");
  return $done();
}

const headers = {
  "User-Agent": "oppostore/406101 (iPhone; iOS 16.6)",
  "Content-Type": "application/json",
  "constToken": token
};

const body = JSON.stringify({
  activityId: activityId,
  business: 1
});

$httpClient.post(
  {
    url: "https://hd.opposhop.cn/api/cn/oapi/marketing/cumulativeSignIn/signIn",
    headers,
    body,
    timeout: TIMEOUT
  },
  (err, resp, data) => {
    if (err) {
      notify("âŒ ç­¾åˆ°è¯·æ±‚å¤±è´¥");
      return $done();
    }

    let res;
    try {
      res = JSON.parse(data);
    } catch {
      notify("âŒ è¿”å›æ•°æ®è§£æå¤±è´¥");
      return $done();
    }

    // âœ… æˆåŠŸç­¾åˆ°
    if (res.code === 200 && res.data?.receiveStatus) {
      const reward = res.data.awardValue || 0;
      notify(`ğŸ‰ ç­¾åˆ°æˆåŠŸï¼Œè·å¾— ${reward} ç§¯åˆ†`);
      return $done();
    }

    // âœ… å·²ç­¾åˆ°
    if (res.message?.includes("å·²ç­¾åˆ°")) {
      notify("âœ… ä»Šæ—¥å·²ç­¾åˆ°");
      return $done();
    }

    // âš ï¸ ç™»å½•æ€å¤±æ•ˆ
    if (res.message?.includes("token")) {
      notify("âš ï¸ ç™»å½•å¤±æ•ˆï¼Œè¯·é‡æ–°æŠ“ constToken");
      return $done();
    }

    // âš ï¸ æ´»åŠ¨å¼‚å¸¸
    if (res.message?.includes("æ´»åŠ¨")) {
      notify(`âš ï¸ æ´»åŠ¨å¼‚å¸¸ï¼š${res.message}`);
      return $done();
    }

    notify(res.message || "âš ï¸ ç­¾åˆ°å¤±è´¥");
    return $done();
  }
);