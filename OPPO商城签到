/**
 * OPPO å•†åŸ ç­¾åˆ°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
 */

const TOKEN_KEY = "oppo_constToken";
const ACTIVITY_KEY = "oppo_activityId";
const TIMEOUT = 5000;

const token = $persistentStore.read(TOKEN_KEY);
const activityId = $persistentStore.read(ACTIVITY_KEY);

function notify(title, msg) {
  $notification.post(title, "", msg);
}

if (!token) {
  notify("OPPO å•†åŸç­¾åˆ°", "âŒ æœªè·å– constToken");
  return $done();
}

if (!activityId) {
  notify("OPPO å•†åŸç­¾åˆ°", "âŒ æœªè·å– activityIdï¼Œè¯·å…ˆæ‰‹åŠ¨æ‰“å¼€ç­¾åˆ°é¡µ");
  return $done();
}

const headers = {
  "User-Agent": "oppostore/406101 (iPhone; iOS 16.6)",
  "Content-Type": "application/json",
  "constToken": token
};

// è¯·æ±‚å°è£…
function request(method, url, body, cb) {
  const options = {
    url,
    headers,
    timeout: TIMEOUT
  };
  if (body) options.body = body;

  $httpClient[method](options, cb);
}

// â‘  è·å–ç­¾åˆ°è¯¦æƒ…
const detailUrl =
  "https://hd.opposhop.cn/api/cn/oapi/marketing/cumulativeSignIn/getSignInDetail?activityId=" +
  activityId;

request("get", detailUrl, null, (err, resp, data) => {
  if (err) {
    notify("OPPO å•†åŸç­¾åˆ°", "âŒ è·å–ç­¾åˆ°è¯¦æƒ…å¤±è´¥");
    return $done();
  }

  let detail;
  try {
    detail = JSON.parse(data);
  } catch {
    notify("OPPO å•†åŸç­¾åˆ°", "âŒ ç­¾åˆ°è¯¦æƒ…è§£æå¤±è´¥");
    return $done();
  }

  if (detail.code !== 200 || !detail.data) {
    notify("OPPO å•†åŸç­¾åˆ°", detail.message || "âŒ ç­¾åˆ°æ´»åŠ¨æ— æ•ˆ");
    return $done();
  }

  const actionId = detail.data.creditsAddActionId;
  if (!actionId) {
    notify("OPPO å•†åŸç­¾åˆ°", "âŒ æœªè·å– actionIdï¼ˆå¯èƒ½æ´»åŠ¨å·²ç»“æŸï¼‰");
    return $done();
  }

  // â‘¡ æ‰§è¡Œç­¾åˆ°
  const body = JSON.stringify({
    activityId,
    creditsAddActionId: actionId,
    business: 1
  });

  request(
    "post",
    "https://hd.opposhop.cn/api/cn/oapi/marketing/cumulativeSignIn/signIn",
    body,
    (e, r, d) => {
      if (e) {
        notify("OPPO å•†åŸç­¾åˆ°", "âŒ ç­¾åˆ°è¯·æ±‚å¤±è´¥");
        return $done();
      }

      let res;
      try {
        res = JSON.parse(d);
      } catch {
        notify("OPPO å•†åŸç­¾åˆ°", "âŒ ç­¾åˆ°è¿”å›è§£æå¤±è´¥");
        return $done();
      }

      if (res.code === 200 && res.data?.receiveStatus) {
        const reward = res.data.awardValue || 0;
        notify("OPPO å•†åŸç­¾åˆ°æˆåŠŸ", `ğŸ‰ è·å¾— ${reward} ç§¯åˆ†`);
        return $done();
      }

      if (res.message?.includes("å·²ç­¾åˆ°")) {
        notify("OPPO å•†åŸç­¾åˆ°", "âœ… ä»Šæ—¥å·²ç­¾åˆ°");
        return $done();
      }

      if (res.message?.includes("token")) {
        notify("OPPO å•†åŸç­¾åˆ°", "âš ï¸ ç™»å½•å¤±æ•ˆï¼Œè¯·é‡æ–°æŠ“ constToken");
        return $done();
      }

      notify("OPPO å•†åŸç­¾åˆ°", res.message || "âš ï¸ ç­¾åˆ°å¤±è´¥");
      return $done();
    }
  );
});