/**
 * OPPO å•†åŸ ç­¾åˆ°
 */

const TOKEN_KEY = "oppo_constToken";
const ACTIVITY_KEY = "oppo_activityId";

const token = $persistentStore.read(TOKEN_KEY);
const activityId = $persistentStore.read(ACTIVITY_KEY);

if (!token) {
  $notification.post("OPPO å•†åŸç­¾åˆ°", "", "âŒ æœªè·å– constCookie");
  return $done();
}

if (!activityId) {
  $notification.post(
    "OPPO å•†åŸç­¾åˆ°",
    "",
    "âŒ æœªè·å– activityIdï¼Œè¯·å…ˆæ‰“å¼€ä¸€æ¬¡ç­¾åˆ°é¡µ"
  );
  return $done();
}

const headers = {
  "User-Agent": "oppostore/406101 IOS/26.2",
  "Content-Type": "application/json",
  "constToken": token
};

// â‘  è·å–ç­¾åˆ°è¯¦æƒ…ï¼ˆå¿…é¡»ï¼‰
const detailUrl =
  "https://hd.opposhop.cn/api/cn/oapi/marketing/cumulativeSignIn/getSignInDetail?activityId=" +
  activityId;

$httpClient.get({ url: detailUrl, headers }, (err, resp, data) => {
  if (err) {
    $notification.post("OPPO å•†åŸç­¾åˆ°", "", "âŒ è·å–ç­¾åˆ°è¯¦æƒ…å¤±è´¥");
    return $done();
  }

  let detail;
  try {
    detail = JSON.parse(data);
  } catch {
    $notification.post("OPPO å•†åŸç­¾åˆ°", "", "âŒ ç­¾åˆ°è¯¦æƒ…è§£æå¤±è´¥");
    return $done();
  }

  if (detail.code !== 200 || !detail.data) {
    $notification.post(
      "OPPO å•†åŸç­¾åˆ°",
      "",
      detail.message || "âŒ ç­¾åˆ°æ´»åŠ¨æ— æ•ˆ"
    );
    return $done();
  }

  const actionId = detail.data.creditsAddActionId;
  if (!actionId) {
    $notification.post(
      "OPPO å•†åŸç­¾åˆ°",
      "",
      "âŒ æœªè·å– creditsAddActionId"
    );
    return $done();
  }

  // â‘¡ æ‰§è¡Œç­¾åˆ°
  const body = JSON.stringify({
    activityId: activityId,
    creditsAddActionId: actionId,
    business: 1
  });

  $httpClient.post(
    {
      url: "https://hd.opposhop.cn/api/cn/oapi/marketing/cumulativeSignIn/signIn",
      headers,
      body
    },
    (e, r, d) => {
      if (e) {
        $notification.post("OPPO å•†åŸç­¾åˆ°", "", "âŒ ç­¾åˆ°è¯·æ±‚å¤±è´¥");
        return $done();
      }

      let res;
      try {
        res = JSON.parse(d);
      } catch {
        $notification.post("OPPO å•†åŸç­¾åˆ°", "", "âŒ ç­¾åˆ°è¿”å›è§£æå¤±è´¥");
        return $done();
      }

      // âœ… æˆåŠŸ
      if (res.code === 200 && res.data?.receiveStatus) {
        const reward = res.data.awardValue || 0;
        $notification.post(
          "OPPO å•†åŸç­¾åˆ°æˆåŠŸ",
          "",
          `ğŸ‰ è·å¾— ${reward} ç§¯åˆ†`
        );
        return $done();
      }

      // âš ï¸ å·²ç­¾åˆ° / æ´»åŠ¨æç¤º
      $notification.post(
        "OPPO å•†åŸç­¾åˆ°",
        "",
        res.message || "âš ï¸ ä»Šæ—¥å¯èƒ½å·²ç­¾åˆ°"
      );
      return $done();
    }
  );
});